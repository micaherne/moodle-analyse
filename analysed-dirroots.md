Analysis of use of $CFG->dirroot
===
There are a number of places where the dirroot is used in code on its own. These are clearly not paths to some file, and are often doing some kind of check on the codebase.

| File                                         | Line                            | Code                                                                                                                                                                 | Analysis                                                                                                                                        | Conclusion                                                                                                                                               | Notes |
|----------------------------------------------|---------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|-----|
| admin/cli/svgtool.php                        | 32                              | <pre>list($options, $unrecognized) = cli_get_params(array('help'=>false, 'ie9fix'=>false, 'noaspectratio'=>false, 'path'=>$CFG->dirroot), array('h'=>'help'));</pre> | Default directory for "tweaking" SVG images                                                                                                     | OK. This is just a default                                                                                                                               |
| admin/plugins.php                            | 153                             | <pre>'dirroot' => $CFG->dirroot</pre>                                                                                                                                | Used for error message after check on L151 which can be rewritten                                                                               | OK but needs replaced                                                                                                                                    |
| admin/tool/monitor/classes/eventlist.php     | 139                             | <pre>$directoryroot = $CFG->dirroot</pre>                                                                                                                            | Used in \tool_monitor\eventlist::get_file_list() to determine whether the directory it's called with is outside the codebase.                   | Not OK but can be replaced with core_codebase::in_codebase()                                                                                             |
| admin/tool/componentlibrary/docspage.php     | 57                              |                                                                                                                                                                      | To construct a full URL to a page within the componentlibrary plugin                                                                                                 | Not OK. Could be replaced with core_component                                                                                                   |
| admin/tool/behat/cli/util_single_run.php     | 239                             | <pre>cli_execute_parallel(array($featurestepscmd), __DIR__ . "/../../../../")</pre>                                                                                  | Working directory for a process call                                                                                                            | Unclear. May not be important but needs more investigation.                                                                                              |
| admin/tool/behat/cli/util_single_run.php     | 288                             | <pre>$step[0] = str_replace($realroot, '', $step[0]);</pre>                                                                                                          | Slightly convoluted absolute to relative path conversion                                                                                        | Not OK. Needs more investigation.                                                                                                                        |
| admin/tool/behat/cli/run.php                 | 272                             | <pre>cli_execute_parallel($cmds, __DIR__ . "/../../../../", BEHAT_PARALLEL_START_DELAY)</pre>                                                                        | Used as cwd for running process                                                                                                                 | Unclear. May be very important. Needs more investigation                                                                                                 |
| admin/tool/behat/tests/manager_util_test.php | 455                             | <pre>$oldroot = $CFG->dirroot;</pre>                                                                                                                                 | Backup of dirroot for unit test, something to do with MDL-55722                                                                                 | OK. Unit test may fail                                                                                                                                   |
| report/eventlist/classes/list_generator.php  | 196                             | <pre>$directoryroot = $CFG->dirroot</pre>                                                                                                                            | Convoluted absolute to relative path conversion, similar to admin/tool/behat/cli/util_single_run.php:288                                        | Not OK but can probably be replaced with generic absolute to relative call                                                                               |
| lib/adminlib.php                             | 539/565                         | <pre>strrev($CFG->dirroot.'/')</pre>                                                                                                                                 | Used in crazy is_dataroot_insecure() function                                                                                                   | Probably OK but needs more investigation                                                                                                                 |
| lib/portfoliolib.php                         | 1284                            | <pre>preg_quote($CFG->dirroot, 'pipe character')</pre>                                                                                                               | Using regex to get relative path from absolute path (from core_component)                                                                       | Not OK but can be replaced with generic absolute to relative call                                                                                        |
| lib/outputrequirementslib.php                | 591                             | <pre>$CFG->wwwroot.preg_replace('/^'.preg_quote($CFG->dirroot, '/').'/', '', $path);</pre>                                                                           | In jquery_plugin() method. Converting a full codebase path to a web path.                                                                       | Not OK. Could be replaced with a generic method to get a web URL for a codebase path.                                                                    |
| lib/tests/other/todochecker.php              | 50                              | <pre>recurseFolders($CFG->dirroot, 'check_to_dos', $extensionsregex, false, array_keys($thirdparty));</pre>                                                          | Used to recurse all PHP files looking for TODOs. This seems to be a standalone web page for checking code.                                      | Not OK. Could be replaced with an iterator for all code or something. Not a high priority.                                                               |
| lib/tests/component_test.php                 | 81, 82, 141, 169, 173, 533, 632 |                                                                                                                                                                      | These are all in the tests for core_component to check that it provides the correct absolute paths to components.                                                    | Not OK. This would need reworked or changed to use a generic in_codebase() kind of method (or skipped if we had split the codebase)             |
| lib/tests/mustache_template_finder_test.php  | 97                              | <pre>$correct = array_map(function($path) use ($CFG) {return implode('/', [$CFG->dirroot, $path]);}, $paths);</pre>                                                  | Checking that correct paths are returned by mustache_template_finder::get_template_directories_for_component()                                  | Not OK. Unclear what to do to fix it but it's just a unit test so could be skipped.                                                                      |
| lib/tests/moodlelib_test.php                 | 3539                            | <pre>'dirroot' => [$CFG->dirroot],</pre>                                                                                                                             | Used as a location for writing a test attachment for mail sending                                                                               | OK, should still work                                                                                                                                    |
| lib/tests/behat/behat_hooks.php              | 272                             | <pre>$realroot = realpath(__DIR__.'/../../../').'/';</pre>                                                                                                           | Convoluted absolute to relative path conversion, similar to util_single_run.php etc.                                                            | Not OK. Could be replaced with generic absolute to relative call                                                                                         |
| lib/tests/admintree_test.php                 | 162                             | <pre>$result = $executable->output_html($CFG->dirroot);</pre>                                                                                                        | Using dirroot as "any old directory" for testing the executable admin type                                                                      | OK. Will still work as long as dirroot is set                                                                                                            |
| lib/classes/event/manager.php                | 238                             | <pre>$cache->set('dirroot', $CFG->dirroot);</pre>                                                                                                                    | Uses dirroot to ensure that cache is still valid (cache has absolute paths)                                                                     | OK. Should still work as long as dirroot is set.                                                                                                         |
| lib/classes/task/manager.php                 | 1125                            | <pre>$pathcomponents = [$CFG->dirroot, $CFG->admin, 'cli', 'scheduled_task.php'];</pre>                                                                              | Creating absolute path to CLI script.                                                                                                           | OK. Should still work as long as dirroot is set to the "core" directory as this script is not in a plugin or subsystem.                                  |
| lib/classes/update/code_manager.php          | 67                              | <pre>$dirroot = $CFG->dirroot;</pre>                                                                                                                                 | Defaulting in constructor of \core\update\code_manager() if dirroot not passed                                                                  | OK in itself, but the whole update manager may not work well if the codebase is separated.                                                               |
| lib/moodlelib.php                            | 6170                            |                                                                                                                                                                      | Allowed path for attachments to be added in email_to_user()                                                                                                          | Not OK. This may not work at all if separated out.                                                                                              |
| lib/deprecatedlib.php                        | 79, 112                         | <pre>$dlength = strlen($CFG->dirroot);</pre>                                                                                                                         | Simple absolute to relative path in deprecated \get_core_subsystems() function / \get_plugin_types() function                                   | Not OK but can be replaced with generic absolute to relative path call                                                                                   |
| lib/pdflib.php                               | 135                             | <pre>define('K_PATH_IMAGES', $CFG->dirroot . '/');</pre>                                                                                                             | Very unclear. Looks like it may be fudging a required but not used parameter for a third-party lib                                              | Unclear                                                                                                                                                  |
| lib/phpunit/classes/util.php                 | 522, 540                        | <pre>$dir = substr($fulldir, strlen($CFG->dirroot) + 1);</pre>                                                                                                       | Simple absolute to relative path conversion                                                                                                     | Not OK but can be replaced with generic absolute to relative path call                                                                                   |
| lib/phpunit/classes/util.php                 | 572                             | <pre>is_writable($CFG->dirroot)</pre>                                                                                                                                | Check whether dirroot is writable                                                                                                               | OK. Will still work as long as dirroot is set.                                                                                                           |
| lib/phpunit/classes/util.php                 | 641                             | <pre>$level = substr_count(str_replace('\\', '/', $cpath), '/') - substr_count(str_replace('\\', '/', $CFG->dirroot), '/');</pre>                                    | Work out how many .. components to add for relative link to phpunit schema in build_component_configs()                                         | Not OK. Could be troublesome to replace if schema path can't be absolute. Probably the schema path doesn't actually affect operation of anything though. |
| lib/testing/lib.php                          | 50                              | <pre>$cwd = dirname(dirname(__DIR__));</pre>                                                                                                                         | Used in the \testing_cli_argument_path() method to get a working directory if called over the web (although this surely shouldn't happen?)      | Not OK. This whole function would need redone as it's predicated on getting a relative path and converting it to an absolute path.                       |There is a use of dirroot on line 61 which has not been picked up|
| lib/testing/lib.php                          | 191                             | <pre>$dirroot = dirname(dirname(__DIR__));</pre>                                                                                                                     | Used in the \testing_update_composer_dependencies() for downloading composer.phar to dirroot and checking the existence of the vendor directory | Probably OK if dirroot is still set. Needs checked though|
|lib/testing/classes/tests_finder.php| 149                             |                                                                                                                                                                      | In \tests_finder::get_all_directories_with_tests(). This returns a list of relative paths.                                                                           |Not OK. Will probably need redone to deal with different layout.| Called by \tests_finder::get_components_with_tests() which I can't make much sense of. I think it's to find tests in random directories which may not be necessary now?|
|lib/outputlib.php| 1479                            | <pre>'sourceMapBasepath' => str_replace('\\', '/', $CFG->dirroot),</pre>                                                                                             |Javascript source map stuff. It's basically sent to \ScssPhp\ScssPhp\Compiler so it's not clear whether it would support non-relative directories.|Not OK|
|lib/upgradelib.php| 153/156                         |                                                                                                                                                                      | In \plugin_misplaced_exception() which would clearly need reworked                                                                                                   |Not OK. plugin_misplaced_exception and any calls need updated|
|lib/behat/lib.php|468| <pre>$dirrootrealpath = str_replace("\\", "/", realpath($CFG->dirroot));</pre>                                                                                       |Serious directory wrangling in \behat_get_run_process()|Not OK. Would probably need reworked.|
|lib/behat/classes/behat_config_manager.php|296|<pre>symlink($CFG->dirroot, $link)</pre>|Symlinking for parallel behat processes|Not OK. Would need reworked|
|lib/behat/classes/behat_config_util.php|250, 531, 851, 1342| |Behat stuff|Not OK. Would need reworked|
|lib/behat/classes/behat_command.php|153|<pre>chdir($CFG->dirroot)</pre>|Deliberately changes to dirroot to run behat command|Not OK. This is probably important|
|grade/lib.php|1413|<pre>$dirroot_length = strlen($CFG->dirroot) + 1;</pre>|Converting passed file path to series of links for \grade_build_nav() function|May be OK. This is only used in a couple of places and should be fine if grade is part of core|
|mnet/xmlrpc/serverlib.php|594|<pre>$path = substr($path, strlen($CFG->dirroot)+1);</pre>|Trimming given path from core_component to compare with relative path in request|Not OK. Probably needs to be calculating a route / notional path from a component path|
